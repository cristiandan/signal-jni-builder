name: Build libsignal_jni (Linux ARM64)
on:
  workflow_dispatch:

jobs:
  build-arm64-qemu:
    name: Build ARM64 via QEMU
    runs-on: ubuntu-22.04
    steps:
      - name: Setup QEMU
        uses: docker/setup-qemu-action@v3
      - name: Setup Buildx
        uses: docker/setup-buildx-action@v3
      - name: Prepare workspace
        run: mkdir -p $GITHUB_WORKSPACE/out
      - name: Run ARM64 build container
        run: |
          docker run --platform=linux/arm64 -v "$GITHUB_WORKSPACE/out:/out" --rm ubuntu:22.04 bash -lc '
            set -e
            
            # Fix any broken deps first
            apt-get update
            apt-get -y --fix-broken install
            
            # Install base deps
            apt-get install -y git curl unzip build-essential \
              openjdk-21-jdk-headless pkg-config cmake clang wget
            
            # Install newer protoc (v25.x supports proto3 optional natively)
            PROTOC_VERSION=25.1
            wget -q https://github.com/protocolbuffers/protobuf/releases/download/v${PROTOC_VERSION}/protoc-${PROTOC_VERSION}-linux-aarch_64.zip -O /tmp/protoc.zip
            unzip -q /tmp/protoc.zip -d /usr/local
            rm /tmp/protoc.zip
            protoc --version
            
            # Install Android SDK + NDK (needed during Gradle configuration)
            mkdir -p /opt/android-sdk/cmdline-tools
            cd /opt/android-sdk/cmdline-tools
            wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -O tools.zip
            unzip -q tools.zip
            mv cmdline-tools latest
            rm tools.zip
            export ANDROID_HOME=/opt/android-sdk
            export PATH=$PATH:$ANDROID_HOME/cmdline-tools/latest/bin
            yes | sdkmanager --licenses > /dev/null 2>&1 || true
            sdkmanager "platforms;android-34" "build-tools;34.0.0" "ndk;28.0.13004108" > /dev/null
            
            # Install Rust
            curl -fsSL https://sh.rustup.rs | sh -s -- -y
            . $HOME/.cargo/env
            
            # Clone and build
            git clone https://github.com/signalapp/libsignal-client.git /work/libsignal-client
            cd /work/libsignal-client/java
            
            # Configure for low-memory build
            mkdir -p $HOME/.cargo
            printf "[build]\njobs = 1\n" > $HOME/.cargo/config.toml
            export RUSTFLAGS="-Ccodegen-units=1"
            
            # Build desktop JNI
            ./gradlew --no-daemon :makeJniLibrariesDesktop
            
            # Copy output
            find /work/libsignal-client/java -name "libsignal_jni*.so" -exec cp {} /out/ \;
          '
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: libsignal_jni-linux-arm64
          path: out/*.so
